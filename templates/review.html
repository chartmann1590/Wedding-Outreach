{% extends "base.html" %}

{% block title %}Review Guests - Wedding Outreach{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">Review Guests</h1>
        <div class="text-sm text-gray-500">
            Page {{ pagination.page }} of {{ pagination.pages }} ({{ pagination.total }} total guests)
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white p-4 rounded-lg shadow-sm border">
        <form method="GET" class="flex flex-wrap gap-4 items-end">
            <div>
                <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select name="status" id="status" 
                        class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All</option>
                    <option value="needs_address" {% if current_filter == 'needs_address' %}selected{% endif %}>Need Address</option>
                    <option value="has_address" {% if current_filter == 'has_address' %}selected{% endif %}>Has Address</option>
                    <option value="requested" {% if current_filter == 'requested' %}selected{% endif %}>Requested</option>
                    <option value="not_on_fb" {% if current_filter == 'not_on_fb' %}selected{% endif %}>Not on FB</option>
                </select>
            </div>

            <div>
                <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" 
                       name="search" 
                       id="search" 
                       value="{{ search_query }}"
                       placeholder="Search by name..."
                       class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>

            <button type="submit" 
                    class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90 transition-colors">
                Filter
            </button>
        </form>
    </div>

    <!-- Guest List -->
    <div class="space-y-4" id="guest-list">
        {% for item in guest_data %}
        <div class="bg-white p-6 rounded-lg shadow-sm border guest-card" 
             data-guest-id="{{ item.guest.id }}" 
             tabindex="0">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h3 class="text-lg font-medium text-gray-900">{{ item.guest.name }}</h3>
                    {% if item.guest.note %}
                    <p class="text-sm text-gray-600 mt-1">{{ item.guest.note }}</p>
                    {% endif %}
                </div>
                
                <div class="flex gap-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if item.guest.status == 'has_address' %}bg-green-100 text-green-800
                        {% elif item.guest.status == 'requested' %}bg-blue-100 text-blue-800
                        {% elif item.guest.status == 'not_on_fb' %}bg-gray-100 text-gray-800
                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        {{ item.guest.status.replace('_', ' ').title() }}
                    </span>
                </div>
            </div>

            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm font-medium text-gray-700">Address:</div>
                    <button onclick="editAddress({{ item.guest.id }})" 
                            class="text-xs text-primary hover:text-primary/80 underline">
                        {% if item.guest.address %}Edit{% else %}Add{% endif %}
                    </button>
                </div>
                <div id="address-display-{{ item.guest.id }}" class="{% if not item.guest.address %}text-gray-400 italic{% endif %}">
                    {{ item.guest.address if item.guest.address else 'No address on file' }}
                </div>
                <div id="address-edit-{{ item.guest.id }}" class="hidden">
                    <div class="flex gap-2">
                        <input type="text" 
                               id="address-input-{{ item.guest.id }}"
                               value="{{ item.guest.address or '' }}"
                               placeholder="Enter address"
                               class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary">
                        <button onclick="saveAddress({{ item.guest.id }})" 
                                class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">
                            Save
                        </button>
                        <button onclick="cancelEditAddress({{ item.guest.id }})" 
                                class="bg-gray-600 text-white px-2 py-1 rounded text-xs hover:bg-gray-700">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">Personal Message:</span>
                    <div class="flex gap-2">
                        <button onclick="copyAndOpenMessenger(this, '{{ item.messenger_link }}')" 
                                class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors flex items-center gap-1 font-medium"
                                title="Copy message and open Facebook Messenger chat with {{ item.guest.name }}">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2ZM12,11L8,8L8,16L12,13L16,16L16,8L12,11Z"/>
                            </svg>
                            Send Message
                        </button>
                    </div>
                </div>
                
                <div class="relative">
                    <textarea readonly 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-sm resize-none message-text"
                              rows="3">{{ item.message }}</textarea>
                </div>
            </div>

            {% if item.guest.status in ['needs_address', 'requested'] %}
            <div class="flex gap-2">
                {% if item.guest.status == 'needs_address' %}
                <button onclick="markGuest({{ item.guest.id }}, 'requested')" 
                        class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">
                    Mark Requested
                </button>
                {% endif %}
                
                <button onclick="markGuest({{ item.guest.id }}, 'not_on_fb')" 
                        class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 transition-colors">
                    Mark Not on FB
                </button>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-500">
            <p>No guests found matching your filters.</p>
            <a href="{{ url_for('review') }}" class="text-primary hover:text-primary/80 underline">View all guests</a>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div class="flex justify-center items-center space-x-4 bg-white p-4 rounded-lg shadow-sm border">
        <!-- Previous Page -->
        {% if pagination.has_prev %}
        <a href="{{ url_for('review', page=pagination.prev_num, status=current_filter, search=search_query) }}" 
           class="bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-md text-sm font-medium text-gray-700 transition-colors">
            Previous
        </a>
        {% else %}
        <span class="bg-gray-50 px-3 py-2 rounded-md text-sm font-medium text-gray-400 cursor-not-allowed">
            Previous
        </span>
        {% endif %}
        
        <!-- Page Numbers -->
        <div class="flex space-x-1">
            {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                    {% if page_num != pagination.page %}
                    <a href="{{ url_for('review', page=page_num, status=current_filter, search=search_query) }}" 
                       class="bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-md text-sm font-medium text-gray-700 transition-colors">
                        {{ page_num }}
                    </a>
                    {% else %}
                    <span class="bg-primary text-white px-3 py-2 rounded-md text-sm font-medium">
                        {{ page_num }}
                    </span>
                    {% endif %}
                {% else %}
                <span class="px-3 py-2 text-sm text-gray-400">â€¦</span>
                {% endif %}
            {% endfor %}
        </div>
        
        <!-- Next Page -->
        {% if pagination.has_next %}
        <a href="{{ url_for('review', page=pagination.next_num, status=current_filter, search=search_query) }}" 
           class="bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-md text-sm font-medium text-gray-700 transition-colors">
            Next
        </a>
        {% else %}
        <span class="bg-gray-50 px-3 py-2 rounded-md text-sm font-medium text-gray-400 cursor-not-allowed">
            Next
        </span>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="fixed bottom-4 right-4 bg-white p-4 rounded-lg shadow-lg border">
    <div class="text-xs text-gray-600 space-y-1">
        <div><strong>Keyboard shortcuts:</strong></div>
        <div><kbd class="bg-gray-100 px-1 rounded">Enter</kbd> - Open chat</div>
        <div><kbd class="bg-gray-100 px-1 rounded">C</kbd> - Copy message</div>
        <div><kbd class="bg-gray-100 px-1 rounded">R</kbd> - Mark requested</div>
        <div><kbd class="bg-gray-100 px-1 rounded">N</kbd> - Mark not on FB</div>
    </div>
</div>
{% endblock %}